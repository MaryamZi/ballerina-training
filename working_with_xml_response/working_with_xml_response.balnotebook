[{"kind":1,"language":"markdown","value":"In this sample, we will be looking at working with XML in Ballerina. We will use the HTTP client to retrieve population data via the [World Bank Indicators API](https://datahelpdesk.worldbank.org/knowledgebase/articles/889392-about-the-indicators-api-documentation) and then process the retrieved data.","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"This sample demonstrates the following.\n- Using an HTTP client to retrieve XML data\n- Query expressions\n- XML subtypes and attributes\n- Defining and using application-specific types corresponding to JSON payload","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Let's first import the required modules. ","outputs":[],"executionSummary":{},"metadata":{}},{"kind":2,"language":"ballerina","value":"import ballerina/http;\nimport ballerina/io;","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Let's now implement the logic step by step.","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Let's initialize an `http:Client` object specifying the URL for the World Bank API. Note that we have had to pass 1.1 as the HTTP version, since the Ballerina HTTP client defaults to 2.0 as the version, but the backend doesn't support the same.","outputs":[],"executionSummary":{},"metadata":{}},{"kind":2,"language":"ballerina","value":"final http:Client worldBankClient = check new (\"http://api.worldbank.org/v2\", httpVersion = http:HTTP_1_1);","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Let's assume we have a parameter named `country` that holds the country code for the data we are interested in. This can also be a variable (local, configurable, module-level, etc.) or even a constant.","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Let's retrieve the data for the country in XML format and write it to a file to examine the data.","outputs":[],"executionSummary":{},"metadata":{}},{"kind":2,"language":"ballerina","value":"function retrieveData(string country) returns error? {\n    xml payload = check worldBankClient->get(string `/country/${country}/indicator/SP.POP.TOTL`);\n    check io:fileWriteXml(\"all.xml\", payload);\n}","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Notes:\n- `country` is used as an interpolation in the string template expression that is the argument to `get`. See [string template expressions](https://ballerina.io/learn/by-example/backtick-templates/).\n- the `get` remote method uses the contextually-expected type (`xml` from the left-hand side here) to try and bind the retrieved payload to the specific type. If the attempt to convert/parse as the specific type fails, an error will be returned. See [API docs for the HTTP client's `get` method](https://lib.ballerina.io/ballerina/http/latest/clients/Client#get) and [dependently-typed functions](https://ballerina.io/learn/by-example/dependent-types/).\n- `remote` and `resource` methods indicate network interactions. Such methods have to be called using the `->` syntax. This differentiates between network calls and normal function/method calls.\n- The `get` method and the `io:fileWriteXml` function may return an error value at runtime. Using `check` with an expression that may evaluate to an error results in the error being returned immediately if the expression evaluates to an error at runtime. See [`check` expression](https://ballerina.io/learn/by-example/check-expression/). ","outputs":[],"executionSummary":{},"metadata":{}},{"kind":2,"language":"ballerina","value":"public function main() returns error? {\n    check retrieveData(\"LK\");\n}","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Examining the content written to the file, we can observe that the XML document has separate XML elements representing population data for each year. The elements are named `wb:data` where `wb` is the namespace \"http://www.worldbank.org\".","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Now that we know the structure of the payload, let's update the `retrieveData` function to retrieve the XML elements and iterate through them to collect population data at the end of each decade.","outputs":[],"executionSummary":{},"metadata":{}},{"kind":2,"language":"ballerina","value":"function retrieveData(string country) returns error? {\n    xml payload = check worldBankClient->get(string `/country/${country}/indicator/SP.POP.TOTL`);\n\n    xmlns \"http://www.worldbank.org\" as wb;\n\n    xml<xml:Element> populationEveryDecade = from xml:Element population in payload/<wb:data>\n                                                let xml date = population/<wb:date>,\n                                                    string yearStr = date.data(),\n                                                    int year = check int:fromString(yearStr)\n                                                where year % 10 == 0\n                                                select population;\n            \n    check io:fileWriteXml(\"population_every_decade.xml\", \n                          xml `<wb:data xmlns:wb=\"http://www.worldbank.org\">${populationEveryDecade}</wb:data>`);\n}","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Notes:\n- `xml:Element` is a builtin subtype of `xml` defined in the [`lang.xml` lang library](https://lib.ballerina.io/ballerina/lang.xml/0.0.0) to represent XML element items. Other builtin `xml` subtypes are `xml:Comment`, `xml:ProcessingInstruction`, and `xml:Text`.\n- a [query expression](https://ballerina.io/learn/by-example/#query-expressions) is used to create a sequence of XML elements with just the information from the years (end of a decade) we are interested in\n    - a [`let` clause](https://ballerina.io/learn/by-example/let-clause/) in a query expression allows declaring temporary variables that will be visible in the rest of the query expression\n    - a `where` clause can be used to filter based on the (boolean) result of an expression\n    - a `select` clause specifies the value to include. In this example we select the entire population XML element as is.\n- an `xmlns` statement is used to declare the `wb` XML namespace. Subsequent code can then use this namespace prefix. Also see [XML namespaces](https://ballerina.io/learn/by-example/xml-namespaces/) and [XMLNS declarations](https://ballerina.io/learn/by-example/xmlns-declarations/).\n- XML navigation in the form of `a/<b>` retrieves for every element `e` in `a`, every element named `b` in the children of `e`. Ballerina provides comprehensive support for XML navigation, see [XML navigation](https://ballerina.io/learn/by-example/xml-navigation/).","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Examining the data written to `population_every_decade.xml` now, we can see that it consists of only the filtered data.","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Let's now extract out just the population against the year at the end of each decade. Let's use a query expression to add this information to an in-memory map instead of writing it to a file.","outputs":[],"executionSummary":{},"metadata":{}},{"kind":2,"language":"ballerina","value":"function retrieveData(string country) returns map<int>|error {\n    xml payload = check worldBankClient->get(string `/country/${country}/indicator/SP.POP.TOTL`);\n\n    xmlns \"http://www.worldbank.org\" as wb;\n\n    return map from xml:Element population in payload/<wb:data>\n                let xml date = population/<wb:date>,\n                    string yearStr = date.data(),\n                    int year = check int:fromString(yearStr)\n                where year % 10 == 0\n                select [yearStr, check int:fromString((population/<wb:value>).data())];\n}","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Notes:\n- the return type of the function has been changed to to allow returning a map of integers now\n- in order to create a map with a query expression, the `map` keyword needs to be used before the `from` keyword. The first expression in the list constructor in the `select` clause is used as the key and the second expression is used as the value. Also see [Creating maps with query expressions](https://ballerina.io/learn/by-example/create-maps-with-query/).","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Printing the result returned from this function call, we can now examine the data in the map.","outputs":[],"executionSummary":{},"metadata":{}},{"kind":2,"language":"ballerina","value":"public function main() returns error? {\n    map<int> populationByDecade = check retrieveData(\"LK\");\n    io:println(populationByDecade);\n}","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Output would look similar to\n\n```cmd\n{\"2020\":21919000,\"2010\":20261738,\"2000\":18777606,\"1990\":17325769,\"1980\":15035840}\n```","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Ballerina also supports convenient syntax to access attributes of XML elements. For example, an attribute that is expected to always be present can be accessed using the `a.b` syntax. An optional attribute can be accessed using `a?.b`, and unlike with required attribute access which returns an error if the attribute is not present, optional attribute access will return nil. Also see [XML access](https://ballerina.io/learn/by-example/xml-access/).\n\nAll of the attributes of an XML element can also be accessed using the [`getAttributes()` function](https://lib.ballerina.io/ballerina/lang.xml/0.0.0/functions#getAttributes) defined in the XML lang library. The attributes are returned as a map of strings. Also see the [API documentation for the XML lang library](https://lib.ballerina.io/ballerina/lang.xml/0.0.0) for other functions available for XML.","outputs":[],"executionSummary":{},"metadata":{}},{"kind":2,"language":"ballerina","value":"xml:Element payload = check worldBankClient->get(string `/country/LK/indicator/SP.POP.TOTL`);\n\nstring lastUpdated = check payload.lastupdated;\nio:println(\"Last Updated: \", lastUpdated);\n\nmap<string> attributes = payload.getAttributes();\nio:println(\"All attributes: \", attributes);","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Output would look similar to\n\n```cmd\nLast Updated: 2022-12-22\nAll attributes: {\"{http://www.w3.org/2000/xmlns/}wb\":\"http://www.worldbank.org\",\"page\":\"1\",\"pages\":\"2\",\"per_page\":\"50\",\"total\":\"62\",\"sourceid\":\"2\",\"sourcename\":\"World Development Indicators\",\"lastupdated\":\"2022-12-22\"}\n```","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"**Working with user-defined types**\n\nAs we saw in the previous sample, JSON to user-defined application-specific types is straightforward due to the natural mapping from JSON objects and arrays to Ballerina mappings and lists.\n\nBut, for XML, there is no such direct mapping and therefore, the language does not define a direct XML to record conversion. \n\nHowever, depending on the use-case, you could use the [`xmldata:fromXml` function](https://lib.ballerina.io/ballerina/xmldata/2.3.1/functions#fromXml) in the `ballerina/xmldata` standard library module for conversion from XML to record.","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"Let's first define a record named `PopulationByYear`that maps to each population XML item.\n\nThe field names have to be an exact match with those expected in the payload (including the namespace prefix). `\\` can be used to include non-identifier characters (e.g., `:`) in names of fields. Also see [identifiers](https://ballerina.io/learn/by-example/identifiers/).","outputs":[],"executionSummary":{},"metadata":{}},{"kind":2,"language":"ballerina","value":"type PopulationByYear record {|\n    string wb\\:indicator;\n    string wb\\:country;\n    string wb\\:countryiso3code;\n    string wb\\:date;\n    int wb\\:value;\n    string wb\\:unit;\n    string wb\\:obs_status;\n    int wb\\:decimal;\n|};","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"We can now use this type to convert the retrieved XML payload.","outputs":[],"executionSummary":{},"metadata":{}},{"kind":2,"language":"ballerina","value":"function retrieveData(string country) returns map<int>|error {\n    xml payload = check worldBankClient->get(string `/country/${country}/indicator/SP.POP.TOTL`);\n\n    record {|\n        PopulationByYear[] wb\\:data;\n    |} rec = check xmldata:fromXml(payload/*);\n\n    return map from PopulationByYear population in rec.wb\\:data\n                    let string yearStr = population.wb\\:date,\n                        int year = check int:fromString(yearStr)\n                    where year % 10 == 0\n                    select [yearStr, population.wb\\:value];\n}","outputs":[],"executionSummary":{},"metadata":{}},{"kind":1,"language":"markdown","value":"XML navigation in the form of `payload/*` results in the children of `e`, for every element `e` in `payload`.","outputs":[],"executionSummary":{},"metadata":{}}]